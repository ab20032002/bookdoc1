#!/bin/bash

# BookDoc Iraq - ุชุดุบูู ุงููุดุฑูุน
echo "========================================"
echo "    BookDoc Iraq - ุชุดุบูู ุงููุดุฑูุน"
echo "========================================"
echo

# ุงูุชุญูู ูู ุงููุชุทูุจุงุช
echo "[1/6] ุงูุชุญูู ูู ุงููุชุทูุจุงุช..."

if ! command -v node &> /dev/null; then
    echo "โ Node.js ุบูุฑ ูุซุจุช. ูุฑุฌู ุชุซุจูุชู ูู https://nodejs.org/"
    exit 1
fi

if ! command -v mongod &> /dev/null; then
    echo "โ MongoDB ุบูุฑ ูุซุจุช. ูุฑุฌู ุชุซุจูุชู ูู https://www.mongodb.com/"
    exit 1
fi

echo "โ ุฌููุน ุงููุชุทูุจุงุช ูุชููุฑุฉ"
echo

# ุชุดุบูู MongoDB
echo "[2/6] ุชุดุบูู MongoDB..."
mongod --fork --logpath /tmp/mongod.log
echo "โ ุชู ุชุดุบูู MongoDB"
echo

# ุงูุชุธุงุฑ MongoDB
echo "[3/6] ุงูุชุธุงุฑ MongoDB ููุจุฏุก..."
sleep 5
echo

# ุชุดุบูู ุงูุฎุงุฏู ุงูุฎููู
echo "[4/6] ุชุดุบูู ุงูุฎุงุฏู ุงูุฎููู..."
cd backend
npm start &
BACKEND_PID=$!
cd ..
echo "โ ุชู ุชุดุบูู ุงูุฎุงุฏู ุงูุฎููู (PID: $BACKEND_PID)"
echo

# ุงูุชุธุงุฑ ุงูุฎุงุฏู ุงูุฎููู
echo "[5/6] ุงูุชุธุงุฑ ุงูุฎุงุฏู ุงูุฎููู..."
sleep 10
echo

# ุชุดุบูู ุงูุชุทุจููุงุช
echo "[6/6] ุชุดุบูู ุงูุชุทุจููุงุช..."

# ุชุทุจูู ุงููุฑุถู
cd mobile-app
npm start &
MOBILE_PID=$!
cd ..
echo "โ ุชู ุชุดุบูู ุชุทุจูู ุงููุฑุถู (PID: $MOBILE_PID)"

sleep 3

# ููุญุฉ ุชุญูู ุงูุฃุทุจุงุก
cd doctor-dashboard
npm start &
DOCTOR_PID=$!
cd ..
echo "โ ุชู ุชุดุบูู ููุญุฉ ุชุญูู ุงูุฃุทุจุงุก (PID: $DOCTOR_PID)"

sleep 3

# ููุญุฉ ุชุญูู ุงููุฏูุฑ
cd admin-dashboard
npm start &
ADMIN_PID=$!
cd ..
echo "โ ุชู ุชุดุบูู ููุญุฉ ุชุญูู ุงููุฏูุฑ (PID: $ADMIN_PID)"
echo

echo "========================================"
echo "    ุชู ุชุดุบูู ุงููุดุฑูุน ุจูุฌุงุญ! ๐"
echo "========================================"
echo
echo "๐ ุฑูุงุจุท ุงูุชุทุจููุงุช:"
echo "   ุชุทุจูู ุงููุฑุถู: http://localhost:3000"
echo "   ููุญุฉ ุชุญูู ุงูุฃุทุจุงุก: http://localhost:3001"
echo "   ููุญุฉ ุชุญูู ุงููุฏูุฑ: http://localhost:3002"
echo "   API ุงูุฎุงุฏู ุงูุฎููู: http://localhost:5000"
echo
echo "๐ฑ ููุญุตูู ุนูู ุฃูุถู ุชุฌุฑุจุฉ:"
echo "   1. ุงูุชุญ ุงููุชุตูุญ ูุงุฐูุจ ุฅูู ุงูุฑูุงุจุท ุฃุนูุงู"
echo "   2. ุฌุฑุจ ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ"
echo "   3. ุงุณุชูุดู ุงูููุฒุงุช ุงููุฎุชููุฉ"
echo
echo "โ๏ธ  ูุฅููุงู ุงููุดุฑูุน: ุงุถุบุท Ctrl+C"
echo

# ุฏุงูุฉ ูุฅููุงู ุงููุดุฑูุน
cleanup() {
    echo
    echo "๐ ุฅููุงู ุงููุดุฑูุน..."
    kill $BACKEND_PID $MOBILE_PID $DOCTOR_PID $ADMIN_PID 2>/dev/null
    mongod --shutdown 2>/dev/null
    echo "โ ุชู ุฅููุงู ุฌููุน ุงูุนูููุงุช"
    exit 0
}

# ุฑุจุท ุฅุดุงุฑุฉ ุงูุฅููุงู
trap cleanup SIGINT SIGTERM

# ุงูุชุธุงุฑ ุงููุณุชุฎุฏู
echo "ุงุถุบุท Ctrl+C ูุฅููุงู ุงููุดุฑูุน..."
wait
